<?php

/**
 * @file
 * Módulo para Pagamentos USP
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Form\FormStateInterface;

use Drupal\Core\Entity\EntityInterface;
use Drupal\webform\WebformInterface;
use Drupal\webform\WebformSubmissionInterface;

function webform_boleto_usp_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.webform_boleto_usp':
      return t('Permite o site gerar Pagamentos USP.');
  }
}

function webform_boleto_usp_webform_third_party_settings_form_alter(array &$form, FormStateInterface $form_state) {
    $form['third_party_settings']['webform_boleto_usp'] = [
      '#type' => 'details',
      '#title' => t('Universidade de São Paulo - Pagamentos'),
      '#open' => FALSE,
    ];

    $form['third_party_settings']['webform_boleto_usp']['habilitar_pagamento'] = [
      '#type' => 'checkbox',
      '#title' => t('Habilitar Pagamento'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'habilitar_pagamento', FALSE),

    ];

    $form['third_party_settings']['webform_boleto_usp']['tipo_pagamento'] = [
      '#type'          => 'select',
      '#title'         => t('Tipos'),
      '#empty_option' => t(' -- Selecione o Método de Pagamento-- '),
      '#options'       => [
        'pix'          => t('Pix'),
        'boleto'       => t('Boleto'),
      ],
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'tipo_pagamento'),
      '#states' => [
              'required' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
              'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
            ],
      ];

     $form['third_party_settings']['webform_boleto_usp']['codigoFonteRecurso'] = [
      '#type'          => 'number',
      '#title'         => t('Código da Fonte de Recurso'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'codigoFonteRecurso'),
      '#required'      => FALSE,
      '#states' => [
        'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
        ],
    ];


    $form['third_party_settings']['webform_boleto_usp']['estruturaHierarquica'] = [
      '#type'          => 'textfield',
      '#title'         => t('Centro Gerencial'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'estruturaHierarquica'),
      '#placeholder' => t('Ex.:  \FFLCH\SCINFOR'), // This is the detail text
      '#states' => [
              'required' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
              'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
            ],
    ];

    $form['third_party_settings']['webform_boleto_usp']['dataVencimento'] = [
      '#type'          => 'date',
      '#title'         => t('Data de Vencimento'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'dataVencimento'),
      '#states' => [
              'required' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
              'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
            ],
    ];

    $form['third_party_settings']['webform_boleto_usp']['informacoesSacado'] = [
      '#type'          => 'textfield',
      '#attributes'    => ['size' => 125],
      '#title'         => t('Informações do Sacado'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'informacoesSacado'),
      '#states' => [
              'required' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
              'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
            ],
    ];

    $form['third_party_settings']['webform_boleto_usp']['instrucoesObjetoCobranca'] = [
      '#type'          => 'textfield',
      '#attributes'    => ['size' => 125],
      '#title'         => t('Instruções do Objeto de Cobrança'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'instrucoesObjetoCobranca'),
      '#states' => [
              'required' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
              'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
            ],
    ];

    $form['third_party_settings']['webform_boleto_usp']['valorDocumento'] = [
      '#type'          => 'textfield',
      '#description'   => t("Valor em Reais (Ex.: 10,50)"),
      '#title'         => t('Valor'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'valorDocumento'),
      '#states' => [
              'required' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
              'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
            ],
    ];

    $form['third_party_settings']['webform_boleto_usp']['nomeSacado'] = [
      '#type'          => 'textfield',
      '#description'   => t("Altere para o valor segundo a configuração do campo no formulário."),
      '#attributes'    => ['size' => 25],
      '#title'         => t('Chave para o campo do Nome'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'nomeSacado'),
      '#states' => [
              'required' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
              'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
            ],
    ];

    $form['third_party_settings']['webform_boleto_usp']['codigoEmail'] = [
      '#type'          => 'textfield',
      '#description'   => t("Altere para o valor segundo a configuração do campo no formulário."),
      '#attributes'    => ['size' => 25],
      '#title'         => t('Chave para o campo do E-mail'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'codigoEmail'),
            '#states' => [
              'required' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
              'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
            ],
    ];

    $form['third_party_settings']['webform_boleto_usp']['cpfCnpj'] = [
      '#type'          => 'textfield',
      '#description'   => t("Altere para o valor segundo a configuração do campo no formulário."),
      '#attributes'    => ['size' => 25],
      '#title'         => t('Chave para o campo do CPF'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'cpfCnpj'),
      '#required'      => FALSE,
      '#states' => [
        'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
        ],
    ];

    $form['third_party_settings']['webform_boleto_usp']['numeroUspSacado'] = [
      '#type'          => 'textfield',
      '#description'   => t("Altere para o valor segundo a configuração do campo no formulário."),
      '#attributes'    => ['size' => 25],
      '#title'         => t('Chave para o campo do Número USP'),
      '#default_value' => $form_state->getFormObject()->getEntity()->getThirdPartySetting('webform_boleto_usp', 'numeroUspSacado'),
      '#required'      => FALSE,
      '#states' => [
        'visible' => [
                 ':input[name="third_party_settings[webform_boleto_usp][habilitar_pagamento]"]' => ['checked' => TRUE],
              ],
        ],

      ];

    $form['#submit'][] = 'webform_boleto_usp_webform_settings_submit';

}

//==================================================

function webform_boleto_usp_entity_presave(EntityInterface $entity) {
    if (!$entity instanceof WebformInterface) {
        return;
    }

    $enabled = (bool) $entity->getThirdPartySetting('webform_boleto_usp', 'habilitar_pagamento', FALSE);

  // Verifica qual o tipo de pagamento selecionado.
  $payment_type = $entity->getThirdPartySetting('webform_boleto_usp', 'tipo_pagamento', '');

  // Definição dos campos para PIX.
  $pixvalue = [
    'idfpix' => 'PIX ID',
  ];

  $boletovalue = [
    'codigoIDBoleto' => 'BOLETO ID',
  ];

  if ($enabled && $payment_type === 'pix') {
    // Cria campo oculto para PIX
    foreach ($pixvalue as $key => $title) {
      $entity->setElementProperties($key, [
        '#type'    => 'hidden',
        '#title'   => $title,
        '#private' => TRUE,
      ]);
    }
    // Remove campos de boleto se existirem
    foreach (array_keys($boletovalue) as $key) {
      $entity->deleteElement($key);
    }
  }
  elseif ($enabled && $payment_type === 'boleto') {
    // Cria campo oculto para Boleto
    foreach ($boletovalue as $key => $title) {
      $entity->setElementProperties($key, [
        '#type'    => 'hidden',
        '#title'   => $title,
        '#private' => TRUE,
      ]);
    }
    // Remove campos de PIX se existirem
    foreach (array_keys($pixvalue) as $key) {
      $entity->deleteElement($key);
    }
  }
  else {
    // Se não habilitado ou nenhum tipo selecionado, remove ambos
    foreach (array_keys($pixvalue) as $key) {
      $entity->deleteElement($key);
    }
    foreach (array_keys($boletovalue) as $key) {
      $entity->deleteElement($key);
    }
  }
}




 // public function gera($webform_submission_id) {
 //    $webform_submission = WebformSubmission::load($webform_submission_id);
 //
 //    $msg = '';
 //
 //    if($webform_submission) {
 //
 //      /* Verificamos se há boleto gerado para esse webform_submission */
 //      $data = $webform_submission->getData();
 //      if(isset($data['boleto_status'])){
 //
 //        if($data['boleto_status'] == true) {
 //            $config   = \Drupal::service('config.factory')->getEditable('webform_boleto_usp.settings');
 //            $pay_type = $config->get('pay_type');
 //            $boleto   = new Boleto($config->get('user_id'),$config->get('token'));
 //            $obter    = $boleto->obter($data['boleto_id']);
 //            $response = new Response();
 //            $response->headers->set('Content-Type', 'application/pdf');
 //            $response->setContent(base64_decode($obter['value']));
 //            return $response;
